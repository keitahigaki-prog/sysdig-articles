---
title: "「EICARファイルで検知されない」は正しい——Sysdig Malware Controlの検知方式と正しい動作検証"
type: "tech"
topics: ["sysdig", "security", "falco", "malware", "runtime"]
published: false
---

# はじめに

Sysdig の Malware Control Policy を導入したユーザーから、こんな問い合わせを受けることがあります。

> 「EICARファイルを作成して検証してみたのですが、イベントが一件も上がってきません。設定が間違っているのでしょうか？」

実は、これは設定ミスではありません。**EICARファイルを置くだけでは検知されないのが正しい動作です。**

本記事では、Sysdig Malware Control の検知方式を解説し、実際に検知されるコマンドと検知されないコマンドを実機検証した結果をまとめます。

---

# Sysdig Malware Control の検知方式

## 3つの検知レイヤー

Sysdig Malware Control は、以下の3つの検知手法を組み合わせています。

### 1. ハッシュベース検知（SHA-256）

Sysdig の脅威リサーチチームが管理する既知マルウェアの SHA-256 ハッシュデータベースと照合します。ただし、これは**実行されたバイナリのハッシュ**を照合するものであり、ファイルを置くだけでは発動しません。

### 2. YARAルールベース検知

テキストパターンやバイナリパターンを使った YARA ルールによる検知です。シグネチャのハッシュを変化させてくる**ポリモーフィック型マルウェア**にも有効で、デフォルトで有効化されています。

### 3. 振る舞いベース検知（Behavior-based）

カーネルレベルのシステムコールを eBPF でリアルタイム監視し、不審な実行パターンを検知します。Falco エンジンを基盤としており、プロセスの起動・ファイルアクセス・ネットワーク通信などの振る舞いを監視します。

## なぜ EICAR が検知されないのか

```bash
# これでは検知されない
echo -n 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > eicar.txt
```

EICARはアンチウイルス製品向けのテスト規格であり、**従来型のファイルスキャン（AV）**がこの文字列を「マルウェアのシグネチャ」として認識することを前提としています。

Sysdig Malware Control の検知トリガーは**実行（execution）**です。ファイルを置くだけでは、ハッシュ照合もYARAルールも振る舞い検知も発動しません。

| 検知方式 | EICARが検知されない理由 |
|---------|----------------------|
| ハッシュベース | 実行されたバイナリが対象。ファイル作成は対象外 |
| YARAルール | 実行時のメモリパターンが対象 |
| 振る舞いベース | 実行の振る舞いが対象。ファイル作成は振る舞いではない |

## ファイルレスマルウェアの検知（memfd）

Sysdig Malware Control の注目すべき機能の1つが**ファイルレスマルウェアの検知**です。

攻撃者はディスクに痕跡を残さないために、`memfd_create` システムコールを使ってRAM上にコードを展開・実行する手法を取ります。

```
# ファイルレスマルウェアの実行パターン（概念）
memfd_create()  →  execve()  →  プロセス名が "memfd:XXX" になる
```

Sysdig Agent は `proc.is_exe_from_memfd` フィールドでこれを検知します（Agent 12.15以上で自動有効化、Severity: High）。

---

# 実機検証：何が検知されて、何が検知されないのか

## 検証環境

```
クラウド: AWS
リージョン: ap-northeast-1（東京）
インスタンスタイプ: t3.small
OS: Amazon Linux 2（x86_64）
Sysdig Agent: 最新版
対象ポリシー: Sysdig Secure > Runtime Policies > Malware Control
```

## ✅ 検知成功パターン

### パターン①：一時領域からのスクリプト実行

```bash
# /var/tmp から実行
echo -e '#!/bin/bash\necho hello' > /var/tmp/test.sh
chmod +x /var/tmp/test.sh
/var/tmp/test.sh
rm -f /var/tmp/test.sh

# /dev/shm から実行
echo -e '#!/bin/bash\necho hello' > /dev/shm/test.sh
chmod +x /dev/shm/test.sh
/dev/shm/test.sh
rm -f /dev/shm/test.sh
```

**検知イベント：** `Execution from Temporary Filesystem`

Falco のデフォルトルールには一時領域からのスクリプト実行を検知するルールがあります。重要な注意点として、**`/tmp` はデフォルトルールの対象外**です。

| ディレクトリ | 検知 | 理由 |
|------------|:----:|------|
| `/tmp` | ❌ | 一般的な用途が多く除外されている |
| `/var/tmp` | ✅ | Falco デフォルトルール対象 |
| `/dev/shm` | ✅ | メモリ上の共有領域。ディスクに残らないためマルウェアが好んで使う |

> `/dev/shm` はシステム再起動で消えるメモリベースのファイルシステムです。攻撃者が証拠隠滅のために利用する代表的な場所で、Sysdig はここからの実行を重点的に監視しています。

---

### パターン②：curl | bash（外部URLからの即実行）

```bash
curl -s https://gist.githubusercontent.com/<username>/<gist-id>/raw | bash
```

**検知イベント：** `Python HTTP Server Started` など

> **よくある誤り：** `curl -s https://example.com | bash` を使うと、`example.com` はHTMLを返すため bash が構文エラーになりスクリプトが実行されません。**実際にシェルスクリプトを返す URL** を使うことが必須です。GitHub Gist などに無害なスクリプトを用意するのが手軽です。

```bash
# GitHub Gist の内容（例）
#!/bin/bash
echo "curl | bash detection test - harmless"
```

`curl` でスクリプトを取得して `bash` に渡すパターンは、マルウェアの初動として最も一般的な手法のひとつです。MITRE ATT&CK では [T1059.004（Unix Shell）](https://attack.mitre.org/techniques/T1059/004/) に該当します。

---

### パターン③：netcat 待受

```bash
timeout 5 nc -lvp 4444
```

**検知イベント：**
- `Suspicious Listener Execution Detected`
- `Launch Suspicious Network Tool on Host`

netcat はバックドアの確立や横展開ツールとして広く悪用されており、Falco のデフォルトルールで複数の検知ルールが定義されています。MITRE ATT&CK の [T1059（Command and Scripting Interpreter）](https://attack.mitre.org/techniques/T1059/) および [T1571（Non-Standard Port）](https://attack.mitre.org/techniques/T1571/) に該当します。

---

## ❌ 検知されないパターン（サーバ環境・デフォルトルール）

### EICARファイルの作成

```bash
echo -n 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > eicar.txt
```

前述のとおり、Malware Control は実行の振る舞いを検知するため、ファイルを置くだけでは発動しません。

---

### /tmp からのスクリプト実行

```bash
echo -e '#!/bin/bash\necho hello' > /tmp/test.sh
chmod +x /tmp/test.sh
/tmp/test.sh
```

`/tmp` はデフォルトルールの対象外です。`/var/tmp` または `/dev/shm` を使ってください。

---

### Base64デコード実行

```bash
echo 'ZWNobyBoZWxsbw==' | base64 -d | bash
# bash -c "$(echo 'ZWNobyBoZWxsbw==' | base64 -d)"  # 変形しても同様
```

**技術的な理由：**

シェルスクリプトを実行すると、OSが起動するプロセスは `/bin/bash` です。

```
# Falco が見えるもの
proc.exepath = /bin/bash       ← スクリプトのパスではない
proc.cmdline = bash /dev/shm/test.sh  ← cmdline には含まれる
```

Falco のルールが `proc.exepath` でフィルタリングしている場合、シェルスクリプトはすべて `/bin/bash` として見えるためディレクトリ判断が機能しません（コンパイル済みELFバイナリとは異なります）。

ホスト上でのBase64実行を検知するにはカスタムFalcoルールの追加が必要です。

---

### 疑似リバースシェル（localhost宛）

```bash
timeout 2 bash -c 'bash -i >& /dev/tcp/127.0.0.1/4444 0>&1'
```

localhost 宛のため外部通信系のルールが反応しません。実際の攻撃者が使う外部IPへの接続では検知される可能性があります。

---

## 検知結果まとめ

| パターン | 検知 | 検知イベント名 |
|---------|:----:|-------------|
| `/var/tmp` スクリプト実行 | ✅ | Execution from Temporary Filesystem |
| `/dev/shm` スクリプト実行 | ✅ | Execution from Temporary Filesystem |
| `curl \| bash`（実在するスクリプトURL） | ✅ | Python HTTP Server Started など |
| netcat 待受 | ✅ | Suspicious Listener Execution / Launch Suspicious Network Tool |
| EICARファイル作成 | ❌ | 振る舞いなし（実行なし） |
| `/tmp` スクリプト実行 | ❌ | デフォルトルール対象外 |
| Base64デコード実行（全バリエーション） | ❌ | ホスト上はデフォルトルールなし |
| 疑似リバースシェル（localhost宛） | ❌ | 外部通信なしのため |

---

# イベントが出ない場合のチェックリスト

正しい検証コマンドを使っているのにイベントが出ない場合は、以下を順番に確認してください。

## ① Agent の稼働確認

```bash
sudo systemctl status dragent
```

`active (running)` であることを確認。停止している場合は `sudo systemctl start dragent`。

## ② Runtime 機能の有効確認

```bash
sudo grep -A3 -E 'feature:|security:|falco:' /opt/draios/etc/dragent.yaml
```

以下がすべて設定されていること：

```yaml
feature:
  mode: secure
security:
  enabled: true
falco:
  enabled: true
```

## ③ Collector 接続確認

```bash
sudo grep -i "connect\|POLICIES" /opt/draios/logs/draios.log | tail -10
```

`Connected to collector` や `POLICIES_V2` のログがあれば接続OK。接続失敗の場合はアウトバウンド443番ポートの疎通を確認してください。

## ④ Policy の Scope 設定（最重要）

**Policies → Runtime Policies → Malware Control → Scope タブ**

対象ホストがScopeに含まれているかを確認します。

```yaml
# NG例：別ホストのみ対象になっている
host.hostName = "ip-10-0-1-99"

# OK例：全ホスト対象
host.hostName != ""

# OK例：特定ホストを含める
host.hostName contains "対象サーバのホスト名"
```

**Scopeの設定ミスが最も多い原因です。**

## ⑤ Events 画面の Severity フィルタ

**Threats → Events** で Severity フィルタが **All** になっているか確認。`Low` が除外されていると見落とす場合があります。

## ⑥ Agent バージョン確認

Malware Control Policy には Agent 13.0.1 以上が必要です（fileless malware 検知は 12.15 以上）。

```bash
sudo sysdig-agent --version   # または
dragent --version
```

---

# Policy の管理について

Sysdig の Runtime Policy には3種類の管理形態があります。

| 種類 | 管理者 | 編集可否 | 自動更新 |
|------|--------|---------|---------|
| **Managed Policy** | Sysdig | 有効化・Scope・通知のみ | ✅ 自動 |
| **Managed Ruleset** | ユーザー | ルールの有効/無効切替可 | ✅ 自動 |
| **Custom Policy** | ユーザー | 完全編集可 | ❌ 手動 |

Malware Control はデフォルトで **Managed Policy** として提供されており、Sysdig の脅威リサーチチームによって継続的にルールが更新されます。カスタムルールを追加したい場合は Managed Ruleset を複製して編集します。

---

# ベストプラクティスまとめ

1. **EICARで検証しない**
   Malware Control は実行の振る舞いを検知。EICARはアンチウイルス向けのテスト規格であり、Sysdigの検証には不適切。

2. **`/tmp` ではなく `/var/tmp` または `/dev/shm` を使う**
   `/tmp` はデフォルトFalcoルールの対象外。`/var/tmp` か `/dev/shm` を使う。

3. **`curl | bash` には実在するスクリプトURLを使う**
   HTMLを返すURLでは bash がエラーになりスクリプトが実行されない。GitHub Gistなどに無害なテストスクリプトを用意する。

4. **Scope 設定を最初に確認する**
   コマンドが正しくても、対象ホストがPolicyのScopeに含まれていなければイベントは生成されない。

5. **コンテナ環境ではより多くのパターンが検知される**
   Falco のデフォルトルールはコンテナ内の実行を主対象としており、ホスト上の検知はより限定的。コンテナ内での検証も組み合わせると、より多くのパターンを確認できる。

6. **Prevent モードは Detect で十分に確認してから有効化**
   Prevention（Kill/Stop）はホストではデフォルト無効、コンテナではデフォルト有効です。本番環境で有効化する前に、Detect モードで誤検知がないことを十分に確認してください。

---

# おわりに

「EICARファイルで検知されない＝設定ミス」という誤解は意外と多く見られます。Sysdig Malware Control は従来型のアンチウイルスとは根本的に異なる検知アプローチを取っており、**実行の振る舞いを検知する**という点を理解した上で検証することが重要です。

ハッシュベース・YARAルール・振る舞い検知の3層構造により、シグネチャ回避を試みるポリモーフィック型マルウェアやファイルレスマルウェアにも対応しています。

正しい検証パターンを使えば、ランタイムセキュリティが意図通りに動作していることを確認できます。導入時の動作確認や、顧客への説明の際にお役立てください。

---

# 参考

- [Sysdig Malware Control Policy ドキュメント](https://docs.sysdig.com/en/sysdig-secure/malware_policy/)
- [Sysdig Threat Detection Policies](https://docs.sysdig.com/en/sysdig-secure/threat-detection-policies/)
- [Falco Rules Library](https://docs.sysdig.com/en/sysdig-secure/falco-reference-library/)
- [Fileless Malware Detection with Sysdig Secure](https://sysdig.com/blog/fileless-malware-detection-sysdig-secure)
- [MITRE ATT&CK T1059 - Command and Scripting Interpreter](https://attack.mitre.org/techniques/T1059/)
- [MITRE ATT&CK T1027 - Obfuscated Files or Information](https://attack.mitre.org/techniques/T1027/)
