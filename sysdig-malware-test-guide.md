# Sysdig Malware Control å‹•ä½œæ¤œè¨¼ - å®Œå…¨ã‚¬ã‚¤ãƒ‰

## ğŸ¯ ç›®çš„
Sysdig Runtime / Malware Control Policy ãŒæ­£ã—ãæ¤œçŸ¥ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚

---

## ğŸ“‹ æ¤œè¨¼ã®æµã‚Œï¼ˆå…¨ä½“ï¼‰

```
1. AWS EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
2. Sysdig Agent ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« + Runtimeæœ‰åŠ¹åŒ–
3. Sysdig Secureå´ã§Runtime Policyè¨­å®š
4. æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
5. Threat Eventsç¢ºèª
```

---

## ã‚¹ãƒ†ãƒƒãƒ—1ï¸âƒ£ï¼šEC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ

### æ¨å¥¨ã‚¹ãƒšãƒƒã‚¯
- **OS**: Amazon Linux 2 ã¾ãŸã¯ Ubuntu 20.04/22.04
- **ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—**: t3.small ä»¥ä¸Š
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: 20GBä»¥ä¸Š
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—**:
  - SSH (22) - è‡ªåˆ†ã®IPã®ã¿
  - ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰: 443 (Sysdig Collectorã¸ã®æ¥ç¶šç”¨)

### ä½œæˆæ‰‹é †ï¼ˆAWS CLIï¼‰

```bash
# å¤‰æ•°è¨­å®š
KEY_NAME="your-key-pair-name"
SECURITY_GROUP_ID="sg-xxxxx"
SUBNET_ID="subnet-xxxxx"

# EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆï¼ˆAmazon Linux 2ï¼‰
aws ec2 run-instances \
  --image-id ami-0c55b159cbfafe1f0 \
  --instance-type t3.small \
  --key-name "$KEY_NAME" \
  --security-group-ids "$SECURITY_GROUP_ID" \
  --subnet-id "$SUBNET_ID" \
  --block-device-mappings '[{"DeviceName":"/dev/xvda","Ebs":{"VolumeSize":20}}]' \
  --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=sysdig-malware-test}]'

# ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹IDã‚’å–å¾—
INSTANCE_ID=$(aws ec2 describe-instances \
  --filters "Name=tag:Name,Values=sysdig-malware-test" "Name=instance-state-name,Values=running" \
  --query 'Reservations[0].Instances[0].InstanceId' \
  --output text)

# ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’å–å¾—
PUBLIC_IP=$(aws ec2 describe-instances \
  --instance-ids "$INSTANCE_ID" \
  --query 'Reservations[0].Instances[0].PublicIpAddress' \
  --output text)

echo "EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã•ã‚Œã¾ã—ãŸ"
echo "Instance ID: $INSTANCE_ID"
echo "Public IP: $PUBLIC_IP"
```

### SSHæ¥ç¶š

```bash
ssh -i ~/.ssh/your-key.pem ec2-user@$PUBLIC_IP
```

---

## ã‚¹ãƒ†ãƒƒãƒ—2ï¸âƒ£ï¼šSysdig Agentã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### äº‹å‰æº–å‚™ï¼šAccess Keyã®å–å¾—

1. Sysdig Secureã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°ã‚¤ãƒ³
   - https://secure.sysdig.com/ (US East)
   - https://us2.app.sysdig.com/ (US West)
   - https://eu1.app.sysdig.com/ (Europe)

2. **Settings** â†’ **Agent Installation** â†’ **Access Key** ã‚’ã‚³ãƒ”ãƒ¼

### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ

EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«SSHæ¥ç¶šã—ãŸçŠ¶æ…‹ã§å®Ÿè¡Œï¼š

```bash
# Access Keyã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
export SYSDIG_ACCESS_KEY="your-access-key-here"

# Collectorã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«å¿œã˜ã¦å¤‰æ›´ï¼‰
export SYSDIG_COLLECTOR="collector.sysdigcloud.com"  # US Eastï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
# export SYSDIG_COLLECTOR="us2.app.sysdig.com"      # US West
# export SYSDIG_COLLECTOR="eu1.app.sysdig.com"      # Europe

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
curl -O https://raw.githubusercontent.com/your-repo/sysdig-malware-test-setup.sh

# å®Ÿè¡Œæ¨©é™ä»˜ä¸
chmod +x sysdig-malware-test-setup.sh

# å®Ÿè¡Œ
./sysdig-malware-test-setup.sh
```

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†ã®ç¢ºèª

```bash
# Agentã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
sudo systemctl status dragent

# æ¥ç¶šç¢ºèª
sudo tail -50 /opt/draios/logs/draios.log | grep -i connected
```

---

## ã‚¹ãƒ†ãƒƒãƒ—3ï¸âƒ£ï¼šSysdig Secureå´ã§Runtime Policyè¨­å®š

### æ‰‹é †

1. **Sysdig Secureã‚³ãƒ³ã‚½ãƒ¼ãƒ«** ã«ã‚¢ã‚¯ã‚»ã‚¹

2. **Policies** â†’ **Runtime Policies** ã«ç§»å‹•

3. **Malware Control** ãƒãƒªã‚·ãƒ¼ã‚’æ¤œç´¢

4. ä»¥ä¸‹ã‚’è¨­å®šï¼š
   - âœ… **Status**: Enabled
   - âœ… **Action**: Detectï¼ˆã¾ãŸã¯ Preventï¼‰
   - âœ… **Scope**: å¯¾è±¡ãƒ›ã‚¹ãƒˆã‚’å«ã‚ã‚‹
     - ä¾‹: `host.hostName = "ip-xx-xx-xx-xx"`
     - ã¾ãŸã¯: `agent.tag.role = "malware-test"`

5. **Save** ã‚’ã‚¯ãƒªãƒƒã‚¯

### Scopeè¨­å®šä¾‹

```yaml
# ãƒ›ã‚¹ãƒˆåã§æŒ‡å®š
host.hostName = "ip-172-31-10-20"

# ã‚¿ã‚°ã§æŒ‡å®š
agent.tag.environment = "test"

# ã™ã¹ã¦ã®ãƒ›ã‚¹ãƒˆï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯éæ¨å¥¨ï¼‰
host.hostName != ""
```

---

## ã‚¹ãƒ†ãƒƒãƒ—4ï¸âƒ£ï¼šæ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ

### ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨å®Ÿè¡Œ

```bash
# æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
curl -O https://raw.githubusercontent.com/your-repo/sysdig-malware-test-run.sh

# å®Ÿè¡Œæ¨©é™ä»˜ä¸
chmod +x sysdig-malware-test-run.sh

# å®Ÿè¡Œ
./sysdig-malware-test-run.sh
```

### å®Ÿè¡Œã•ã‚Œã‚‹æ¤œè¨¼å†…å®¹

| # | æ¤œè¨¼å†…å®¹ | æ¤œçŸ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ |
|---|---------|------------|
| â‘  | ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª + å®Ÿè¡Œ | `/tmp` ã‹ã‚‰ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ |
| â‘¡ | Base64 ãƒ‡ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ | é›£èª­åŒ–ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ |
| â‘¢ | curl \| bash ãƒ‘ã‚¿ãƒ¼ãƒ³ | ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å³å®Ÿè¡Œ |
| â‘£ | ç–‘ä¼¼ãƒªãƒãƒ¼ã‚¹ã‚·ã‚§ãƒ« | C2é€šä¿¡é¢¨æŒ™å‹• |
| â‘¤ | netcat å¾…å— | ä¸å¯©ãƒãƒ¼ãƒˆå¾…å— |

---

## ã‚¹ãƒ†ãƒƒãƒ—5ï¸âƒ£ï¼šThreat Eventsã®ç¢ºèª

### ç¢ºèªæ‰‹é †

1. **Sysdig Secureã‚³ãƒ³ã‚½ãƒ¼ãƒ«** â†’ **Threats** â†’ **Events** ã«ç§»å‹•

2. ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šï¼š
   - **Category**: Runtime
   - **Severity**: All
   - **Time Range**: Last 15 minutes

3. æœŸå¾…ã•ã‚Œã‚‹æ¤œçŸ¥ã‚¤ãƒ™ãƒ³ãƒˆï¼š
   - âœ… **Runtime Policy Violation**
   - âœ… **Suspicious Activity**
   - âœ… **Malware-like Behavior**
   - âœ… Process execution from /tmp
   - âœ… Base64 encoded command execution
   - âœ… Suspicious network activity

### ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ã®ç¢ºèªé …ç›®

- **Policy Name**: Malware Controlï¼ˆã¾ãŸã¯è©²å½“ã™ã‚‹ãƒãƒªã‚·ãƒ¼åï¼‰
- **Host**: å¯¾è±¡EC2ã®ãƒ›ã‚¹ãƒˆå
- **Timestamp**: æ¤œè¨¼å®Ÿè¡Œæ™‚åˆ»ã®å‰å¾Œ
- **Severity**: High / Medium / Low
- **Action**: Detect / Prevent

---

## ğŸš¨ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚±ãƒ¼ã‚¹1ï¼šã‚¤ãƒ™ãƒ³ãƒˆãŒæ¤œçŸ¥ã•ã‚Œãªã„

#### ç¢ºèªâ‘ ï¼šAgentæ¥ç¶šçŠ¶æ…‹

```bash
sudo systemctl status dragent
sudo tail -100 /opt/draios/logs/draios.log | grep -i error
```

#### ç¢ºèªâ‘¡ï¼šRuntimeæ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–

```bash
sudo cat /opt/draios/etc/dragent.yaml | grep -A5 "security:"
```

æœŸå¾…ã•ã‚Œã‚‹è¨­å®šï¼š
```yaml
security:
  enabled: true

falco:
  enabled: true
```

#### ç¢ºèªâ‘¢ï¼šPolicy Scope

Sysdig Secureã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ï¼š
- **Policies** â†’ **Runtime Policies** â†’ **Malware Control**
- **Scope** ã‚¿ãƒ–ã§å¯¾è±¡ãƒ›ã‚¹ãƒˆãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

#### ç¢ºèªâ‘£ï¼šSeverityãƒ•ã‚£ãƒ«ã‚¿

- **Threats** â†’ **Events** ã§
- **Severity** ãƒ•ã‚£ãƒ«ã‚¿ãŒ **All** ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª
- ï¼ˆLow SeverityãŒé™¤å¤–ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ï¼‰

### ã‚±ãƒ¼ã‚¹2ï¼šAgentãŒèµ·å‹•ã—ãªã„

#### ç¢ºèªâ‘ ï¼šã‚«ãƒ¼ãƒãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼

```bash
uname -r
ls /usr/src/kernels/$(uname -r) || ls /usr/src/linux-headers-$(uname -r)
```

ãªã‘ã‚Œã°å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼š
```bash
# Amazon Linux 2
sudo yum install -y kernel-devel-$(uname -r)

# Ubuntu
sudo apt-get install -y linux-headers-$(uname -r)

# Agentå†èµ·å‹•
sudo systemctl restart dragent
```

#### ç¢ºèªâ‘¡ï¼šãƒ­ã‚°ç¢ºèª

```bash
sudo journalctl -u dragent -n 100 --no-pager
```

### ã‚±ãƒ¼ã‚¹3ï¼šã‚¤ãƒ™ãƒ³ãƒˆã¯ç”Ÿæˆã•ã‚Œã‚‹ãŒBlockã•ã‚Œãªã„

**ã“ã‚Œã¯æ­£å¸¸ã§ã™**ã€‚

- **Action: Detect** ã®å ´åˆã€ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²ã®ã¿ã§Blockã—ã¾ã›ã‚“
- Blockã™ã‚‹ã«ã¯ **Action: Prevent** ã«å¤‰æ›´ãŒå¿…è¦

---

## ğŸ“Š æˆåŠŸåˆ¤å®šåŸºæº–

### âœ… æ¤œè¨¼æˆåŠŸã¨ã¿ãªã™æ¡ä»¶

1. âœ… **Threat EventãŒç”Ÿæˆã•ã‚Œã‚‹**
   - Threats â†’ Events ã«è¡¨ç¤ºã•ã‚Œã‚‹

2. âœ… **Runtime PolicyåãŒè¡¨ç¤ºã•ã‚Œã‚‹**
   - Policy Name: Malware Control

3. âœ… **å¯¾è±¡ãƒ›ã‚¹ãƒˆåãŒä¸€è‡´**
   - æ¤œè¨¼å®Ÿè¡Œã—ãŸEC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ›ã‚¹ãƒˆå

4. âœ… **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒä¸€è‡´**
   - æ¤œè¨¼å®Ÿè¡Œæ™‚åˆ»ã®å‰å¾Œï¼ˆ30ç§’ã€œ2åˆ†ä»¥å†…ï¼‰

### âš  Blockã•ã‚Œãªãã¦ã‚‚æ­£å¸¸

- Action: Detect ã®å ´åˆã€ã‚¤ãƒ™ãƒ³ãƒˆç”Ÿæˆã®ã¿ã§Blockã—ãªã„
- ã“ã‚Œã¯æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã§ã™

---

## ğŸ§  é‡è¦ãªè£œè¶³

### Malware Controlã®æ¤œçŸ¥æ–¹å¼

Sysdig Malware Control ã¯**ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’æ¤œçŸ¥ã™ã‚‹ã‚¢ãƒ³ãƒã‚¦ã‚¤ãƒ«ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“**ã€‚

**æ¤œçŸ¥å¯¾è±¡**ï¼š
- âœ… å®Ÿè¡ŒæŒ™å‹•ï¼ˆProcess executionï¼‰
- âœ… æ”»æ’ƒTTPï¼ˆTactics, Techniques, and Proceduresï¼‰
- âœ… æ¨©é™æ˜‡æ ¼ï¼ˆPrivilege escalationï¼‰
- âœ… ä¸å¯©é€šä¿¡ï¼ˆSuspicious network activityï¼‰
- âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³

**æ¤œçŸ¥ã•ã‚Œãªã„ã‚‚ã®**ï¼š
- âŒ EICARç­‰ã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå®Ÿè¡Œã•ã‚Œãªã„é™ã‚Šï¼‰
- âŒ é™çš„ãªãƒãƒ«ã‚¦ã‚§ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚¹ã‚­ãƒ£ãƒ³ã¯ã—ãªã„ï¼‰
- âŒ æš—å·åŒ–ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¸­èº«ã¯è¦‹ãªã„ï¼‰

### Falcoãƒ™ãƒ¼ã‚¹ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ æ¤œçŸ¥

Sysdigã¯ **Falco** ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½¿ç”¨ï¼š
- ã‚«ãƒ¼ãƒãƒ«ãƒ¬ãƒ™ãƒ«ã®ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ç›£è¦–
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æŒ™å‹•æ¤œçŸ¥
- ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®è„…å¨åˆ¤å®š

---

## ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

### æ¤œè¨¼å®Œäº†å¾Œã®ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤

```bash
# EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å‰Šé™¤
aws ec2 terminate-instances --instance-ids "$INSTANCE_ID"

# Sysdig AgentãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸEC2ã¯è‡ªå‹•çš„ã«ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‹ã‚‰å‰Šé™¤ã•ã‚Œã‚‹
# ï¼ˆæ•°åˆ†ã€œæ•°æ™‚é–“å¾Œï¼‰
```

---

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- [Sysdig Runtime Security Documentation](https://docs.sysdig.com/en/docs/sysdig-secure/policies/runtime-policies/)
- [Falco Rules](https://github.com/falcosecurity/falco/blob/master/rules/falco_rules.yaml)
- [Sysdig Agent Installation](https://docs.sysdig.com/en/docs/installation/sysdig-agent/)

---

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### äº‹å‰æº–å‚™
- [ ] AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆæº–å‚™å®Œäº†
- [ ] Sysdig Secure Access Key å–å¾—
- [ ] EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ

### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- [ ] Sysdig Agent ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†
- [ ] Runtimeæ©Ÿèƒ½æœ‰åŠ¹åŒ–
- [ ] Agentæ¥ç¶šç¢ºèªï¼ˆãƒ­ã‚°ã§ "connected" ç¢ºèªï¼‰
- [ ] Sysdig Secureã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒ›ã‚¹ãƒˆãŒInventoryã«è¡¨ç¤ºã•ã‚Œã‚‹

### Policyè¨­å®š
- [ ] Malware Control Policy ãŒ Enabled
- [ ] Action ãŒ Detect ã¾ãŸã¯ Prevent
- [ ] Scope ã«å¯¾è±¡ãƒ›ã‚¹ãƒˆãŒå«ã¾ã‚Œã‚‹

### æ¤œè¨¼å®Ÿè¡Œ
- [ ] æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œå®Œäº†
- [ ] ã‚¨ãƒ©ãƒ¼ãªãå…¨5ãƒ‘ã‚¿ãƒ¼ãƒ³å®Ÿè¡Œã•ã‚ŒãŸ

### çµæœç¢ºèª
- [ ] Threats â†’ Events ã«ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤º
- [ ] Policy Name ä¸€è‡´
- [ ] Host Name ä¸€è‡´
- [ ] Timestamp ä¸€è‡´

---

**æ¤œè¨¼æˆåŠŸï¼ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼** ğŸ‰
